# Codebase Knowledge MCP Server

A repository-agnostic MCP server that gives LLMs deep access to any codebase. It allows agents to:
- **List** ranked modules and classes.
- **Inspect** detailed signatures and docstrings (via a pre-computed index).
- **Read** source code directly from Git repositories.
- **Search** the codebase using keywords or concepts.

## Installation (Recommended)

The standard way to use this server is via `uvx`. This method handles installation, environment isolation, and caching automatically.

Add the following configuration to your `~/.gemini/settings.json` file. The server will automatically download the search index (if available in the internal registry) and clone the repository the first time it runs.

```json
{
  "mcpServers": {
    "adk-python": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/ivanmkc/agent-generator.git#subdirectory=tools/adk_knowledge_ext",
        "codebase-knowledge-mcp"
      ],
      "env": {
        "TARGET_REPO_URL": "https://github.com/google/adk-python.git",
        "TARGET_VERSION": "v1.20.0",
        "GEMINI_API_KEY": "YOUR_KEY_HERE" 
      }
    }
  }
}
```

### Automatic System Instructions
To ensure your LLM knows exactly how to use these tools for the target repository, you can instruct the Gemini CLI to use the instructions file generated by the server:

1. **Find your home directory path** (e.g., `/Users/yourname` or `/home/yourname`).
2. Add the `GEMINI_SYSTEM_MD` variable to the `env` block in your `settings.json`:

```json
"env": {
  "TARGET_REPO_URL": "https://github.com/google/adk-python.git",
  "GEMINI_SYSTEM_MD": "/Users/yourname/.mcp_cache/instructions/adk-python.md"
}
```
*(The server automatically updates this file with the correct repository and version metadata on every start.)*

**Why is this needed?**
The MCP protocol doesn't yet allow servers to automatically push system prompts to the client. The `GEMINI_SYSTEM_MD` variable bridges this gap by telling the Gemini CLI to read the context file that the MCP server maintains for you.

## Performance & Caching
*   **Tools:** `uvx` caches the installed python environment, so subsequent runs start instantly.
*   **Data:** The server caches the cloned repository and downloaded index in `~/.mcp_cache/`, ensuring network efficiency.

## Configuration Options

| Variable | Description | Default |
| :--- | :--- | :--- |
| `TARGET_REPO_URL` | **Required.** The Git URL of the codebase to clone. | None |
| `TARGET_VERSION` | The branch or tag to use. | `main` |
| `TARGET_INDEX_URL` | URL to the `ranked_targets.yaml` index file. **Optional** if repo is in internal registry. | Registry Lookup |
| `GEMINI_API_KEY` | API Key for semantic search features. | None |
| `ADK_SEARCH_PROVIDER` | Search mode: `bm25` (local) or `hybrid` (semantic+local). | `bm25` |
| `GEMINI_SYSTEM_MD` | (Gemini CLI only) Path to the system prompt file. | None |

## Manual Installation (Advanced)

If you prefer to manage your own Python environment or need offline capability by bundling data at install time:

```bash
# 1. Set build-time variables (to bundle data and generate instructions)
export TARGET_REPO_URL="https://github.com/google/adk-python.git"
export TARGET_VERSION="v1.20.0"

# 2. Install
pip install "git+https://github.com/ivanmkc/agent-generator.git#subdirectory=tools/adk_knowledge_ext"

# 3. Run
export GEMINI_API_KEY="..."
codebase-knowledge-mcp
```
