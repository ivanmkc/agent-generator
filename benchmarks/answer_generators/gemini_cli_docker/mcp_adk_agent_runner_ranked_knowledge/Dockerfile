ARG BASE_IMAGE=gemini-cli:base
FROM ${BASE_IMAGE}

# Install Python MCP SDK and YAML parser
RUN pip install --no-cache-dir mcp pyyaml rank-bm25

# Clone and Install adk-python
RUN mkdir -p /app && git clone --branch v1.20.0 https://github.com/google/adk-python.git /app/adk-python
RUN pip install --no-cache-dir /app/adk-python

# Create directory for app data
RUN mkdir -p /app/data /app/tools

# Copy the Knowledge Index (Generated by target_ranker.py)
COPY tools/benchmark_generator/data/ranked_targets.yaml /app/data/ranked_targets.yaml

# Copy and install the ADK Knowledge Extension
COPY tools/adk-knowledge-ext /app/extensions/adk-knowledge-ext
RUN pip install --no-cache-dir /app/extensions/adk-knowledge-ext

# Configure Gemini CLI to use the MCP server
COPY benchmarks/answer_generators/gemini_cli_docker/mcp_adk_agent_runner_ranked_knowledge/settings.json /root/.gemini/settings.json

# Copy instructions
COPY benchmarks/answer_generators/gemini_cli_docker/mcp_adk_agent_runner_ranked_knowledge/INSTRUCTIONS_MCP_RUNNER.md /workdir/INSTRUCTIONS.md
ENV GEMINI_SYSTEM_MD=/workdir/INSTRUCTIONS.md
ENV ADK_SEARCH_PROVIDER=bm25

# Set working directory to repo root so relative paths work if needed
WORKDIR /workdir
