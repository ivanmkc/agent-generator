ARG BASE_IMAGE=gemini-cli:base
FROM ${BASE_IMAGE}

# Install Python MCP SDK and YAML parser
RUN pip install --no-cache-dir mcp pyyaml rank-bm25

# Clone and Install adk-python
RUN mkdir -p /app && git clone --branch v1.20.0 https://github.com/google/adk-python.git /app/adk-python
RUN pip install --no-cache-dir /app/adk-python

# Create directory for app data
RUN mkdir -p /app/data /app/tools

# Copy the Knowledge Index (Generated by target_ranker.py)
COPY benchmarks/generator/benchmark_generator/data/ranked_targets.yaml /app/data/ranked_targets.yaml

# Copy and install the ADK Knowledge Extension from local source.
# This is required so:
# 1. The 'codebase-knowledge-mcp-manage' CLI tool is available for the next RUN step.
# 2. We test the local version of the extension rather than downloading it from GitHub/PyPI.
COPY tools/adk_knowledge_ext /app/extensions/adk-knowledge-ext
RUN pip install --no-cache-dir /app/extensions/adk-knowledge-ext

# Run setup to generate configuration and instructions
# We ensure .gemini exists so the setup tool detects it (since we use JSON config mode)
# We run from the extension directory with --local so uvx uses local source
RUN mkdir -p /root/.gemini && \
    mkdir -p /root/.mcp_cache/instructions && \
    cd /app/extensions/adk-knowledge-ext && \
    codebase-knowledge-mcp-manage setup \
    --repo-url "https://github.com/google/adk-python.git" \
    --version "v1.20.0" \
    --knowledge-index-url "file:///app/data/ranked_targets.yaml" \
    --local \
    --force

ENV ADK_SEARCH_PROVIDER=bm25

# Set working directory to repo root so relative paths work if needed
WORKDIR /workdir
